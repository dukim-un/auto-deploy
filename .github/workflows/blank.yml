name: Release Build

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  build-and-release:
    name: Build and Release for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
        shell: bash

      - name: Install dependencies
        run: npm ci

      - name: Build with SEA (optimized)
        run: npm run package:sea-optimized

      - name: Install UPX and Strip
        run: |
          sudo apt-get update
          sudo apt-get install -y upx binutils
          upx --version || echo "UPX installed"
          strip --version || echo "Strip installed"
      - name: Verify build output
        run: ls -lah bin/
        shell: bash

      - name: Create env.example
        run: |
          cat > env/.env.example << 'EOF'
          # Server Configuration
          PORT=3000
          NODE_ENV=production
          # Database Configuration
          DB_HOST=localhost
          DB_PORT=3306
          DB_USER=root
          DB_PASSWORD=your_password
          DB_NAME=zdm_database
          # JWT Configuration
          JWT_SECRET=your_jwt_secret_key_here
          JWT_EXPIRES_IN=24h
          # File Upload
          UPLOAD_PATH=./uploads
          MAX_FILE_SIZE=10485760
          # Logging
          LOG_LEVEL=info
          LOG_DIR=./logs
          EOF
        shell: bash

      - name: Prepare release package
        run: |
          mkdir -p release-package
          if [ -f "bin/zdm-api-sea" ]; then
            cp "bin/zdm-api-sea" "release-package/zdm-api-linux-x64"
          elif [ -f "bin/zdm-api-sea.backup" ]; then
            cp "bin/zdm-api-sea.backup" "release-package/zdm-api-linux-x64"
          else
            echo "Error: Executable not found"
            ls -lah bin/
            exit 1
          fi
          chmod +x "release-package/zdm-api-linux-x64"
          cp -r env release-package/
          cp Readme.md release-package/
          cat > release-package/README.txt << 'READMEEOF'
          ZDM API - Binary Release (Linux x64)
          ====================================
          Installation:
          1. Extract this archive
          2. Copy env/.env.example to env/.env
          3. Edit env/.env with your configuration
          4. Run the executable
          Usage:
            ./zdm-api-linux-x64
          For more information, see Readme.md
          This binary is built with Node.js Single Executable Application (SEA).
          Platform: Linux x64
          Optimization: Strip + esbuild
          READMEEOF
          echo "${{ steps.get_version.outputs.version }}" > release-package/VERSION.txt
          echo "Built from branch: ${{ github.ref_name }}" >> release-package/VERSION.txt
          echo "Commit: ${{ github.sha }}" >> release-package/VERSION.txt
          echo "Platform: Linux x64" >> release-package/VERSION.txt
          echo "Build date: $(date)" >> release-package/VERSION.txt
      - name: Create ZIP package
        run: |
          cd release-package
          zip -r ../zdm-api-linux-x64.zip .
          cd ..
          ls -lah zdm-api-linux-x64.zip
      - name: Calculate SHA256 checksum
        id: checksum
        run: |
          SHA256=$(shasum -a 256 zdm-api-linux-x64.zip | cut -d' ' -f1)
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "SHA256: ${SHA256}"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: zdm-api-linux-x64
          path: zdm-api-linux-x64.zip
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: build-and-release
    runs-on: ubuntu-latest
    if: success()

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts -name "*.zip" -exec cp {} release-files/ \;
          ls -lah release-files/
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          # ZDM API v${{ steps.get_version.outputs.version }}
          Branch: `${{ github.ref_name }}`
          Commit: `${{ github.sha }}`
          Platform: Linux x64
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ## 다운로드 (바이너리 패키지)
          | 파일 | 설명 |
          |------|------|
          | `zdm-api-linux-x64.zip` | Linux 64-bit SEA 실행 파일 |
          ## 빌드 정보
          - 빌드 방식: Node.js SEA
          - 최적화: esbuild + Strip
          - Node.js: v22.x
          - 플랫폼: Linux x64
          - 자동 빌드: GitHub Actions
          EOF
      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: ZDM API ${{ steps.get_version.outputs.tag }} (${{ github.ref_name }})
          body_path: release-notes.md
          files: release-files/*
          draft: false
          prerelease: ${{ github.ref_name == 'dev' }}
          make_latest: ${{ github.ref_name == 'main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Delete auto-generated source archives
        if: success()
        continue-on-error: true # 이 단계가 실패해도 워크플로가 중단되지 않음
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ steps.get_version.outputs.tag }}
        run: |
          echo "Polling for assets to be generated by GitHub (max 2 mins)..."
        
          timeout=120 # 2분 타임아웃
          interval=10 # 10초마다 확인
          elapsed=0
        
          asset_zip_found=false
          asset_tar_found=false
        
          while [ $elapsed -lt $timeout ]; do
            # gh 명령어로 현재 릴리스의 에셋 파일 목록을 가져옵니다.
            asset_names=$(gh release view ${TAG} --json assets --jq '.assets.[].name' --repo ${{ github.repository }} 2>/dev/null || echo "")
        
            # zip 파일 확인
            if [[ "$asset_names" == *"Source code (zip)"* ]]; then
              asset_zip_found=true
            fi
            
            # tar.gz 파일 확인
            if [[ "$asset_names" == *"Source code (tar.gz)"* ]]; then
              asset_tar_found=true
            fi
        
            # 두 파일이 모두 발견되면 루프 종료
            if [ "$asset_zip_found" = true ] && [ "$asset_tar_found" = true ]; then
              echo "Both source archives found. Proceeding with deletion."
              break
            fi
        
            echo "Assets not yet ready, waiting ${interval}s... (Elapsed: ${elapsed}s)"
            sleep $interval
            elapsed=$((elapsed + interval))
          done
        
          if [ "$asset_zip_found" = false ] || [ "$asset_tar_found" = false ]; then
            echo "Warning: Timed out waiting for all source assets to appear."
            [ "$asset_zip_found" = false ] && echo " - 'Source code (zip)' was not found."
            [ "$asset_tar_found" = false ] && echo " - 'Source code (tar.gz)' was not found."
            echo "Will attempt deletion anyway (this may report an error)."
          fi

      - name: Summary
        run: |
          echo "## Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.get_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Platform: Linux x64" >> $GITHUB_STEP_SUMMARY
          echo "Pre-release: ${{ github.ref_name == 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release Package: zdm-api-linux-x64.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
